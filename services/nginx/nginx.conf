    worker_processes auto;

    events {
        worker_connections 1024;
    }

    http {
        gzip on; # Enable gzip compression
        gzip_proxied any;
        gzip_vary on;
        gzip_comp_level 5; # Compression level (1-9). Higher = more compression, but more CPU.
        gzip_types
            text/plain
            text/css
            text/javascript
            application/javascript
            application/x-javascript
            application/json
            application/xml
            application/xml+rss;

        real_ip_header CF-Connecting-IP;
        real_ip_recursive on;

        limit_req_zone $realip_remote_addr zone=signIn_zone:10m rate=3r/m;
        limit_req_zone $realip_remote_addr zone=user_zone:10m rate=500r/s;

        server {
            # Allow Cloudflare IPv4 ranges
            allow 173.245.48.0/20;
            allow 103.21.244.0/22;
            allow 103.22.200.0/22;
            allow 103.31.4.0/22;
            allow 141.101.64.0/18;
            allow 108.162.192.0/18;
            allow 190.93.240.0/20;
            allow 188.114.96.0/20;
            allow 197.234.240.0/22;
            allow 198.41.128.0/17;
            allow 162.158.0.0/15;
            allow 104.16.0.0/13;
            allow 104.24.0.0/14;
            allow 172.64.0.0/13;
            allow 131.0.72.0/22;
            # Allow Cloudflare IPv6 ranges
            allow 2400:cb00::/32;
            allow 2606:4700::/32;
            allow 2803:f800::/32;
            allow 2405:b500::/32;
            allow 2405:8100::/32;
            allow 2a06:98c0::/29;
            allow 2c0f:f248::/32;
            # Allow localhost (Docker healthcheck)
            allow 127.0.0.1;
            # Deny all other IPs
            deny all;

            listen 443 ssl;
            http2 on;
            server_name motowear.gr;

            ssl_certificate /etc/nginx/certs/motowear.gr.pem;
            ssl_certificate_key /etc/nginx/certs/motowear.gr.key;

            # Disable buffering for streaming support
            proxy_buffering off;
            proxy_set_header X-Accel-Buffering no;

            client_max_body_size 500M; # Increase limit to 500 MB
            client_body_buffer_size 256K;  # If it is too much, reduce to 128K.

            # Docker healthcheck
            location /nginx { 
                allow 127.0.0.1;
                deny all;
                access_log off;
                return 200 "ok";
            }

            location /motowear {
                limit_except GET {
                    deny all;
                }
                limit_req zone=user_zone burst=250 nodelay;
                proxy_pass http://stack-motowear_minio:9000;
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            }

            location /typesense/ {
                limit_except GET POST {
                    deny all;
                }
                limit_req zone=user_zone burst=250 nodelay;
                proxy_pass http://stack-motowear_typesense:8108/;
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            }

            location = /api/nextjs {
                return 444;
            }

            location = /api/admin/auth/sign-up/email {
                return 444;
            }

            location = /api/admin/get_cookie {
                limit_except GET {
                    deny all;
                }
                limit_req zone=signIn_zone nodelay;
                proxy_pass http://stack-motowear_nextjs:3000;
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            }

            location = /api/admin/auth/sign-in/email {
                limit_except POST {
                    deny all;
                }
                limit_req zone=signIn_zone nodelay;
                proxy_pass http://stack-motowear_nextjs:3000;
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;            
            }

            location /api/admin/pages/home/image {
                limit_except GET POST DELETE {
                    deny all;
                }
                limit_req zone=user_zone burst=250 nodelay;
                proxy_pass http://stack-motowear_nextjs:3000;
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;        
            }

            location /api/admin/product/brand/ {
                limit_except GET POST DELETE {
                    deny all;
                }
                limit_req zone=user_zone burst=250 nodelay;
                proxy_pass http://stack-motowear_nextjs:3000;
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;        
            }

            location /api/admin/product/product_type/image/ {
                limit_except GET POST DELETE {
                    deny all;
                }
                limit_req zone=user_zone burst=250 nodelay;
                proxy_pass http://stack-motowear_nextjs:3000;
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;        
            }

            location = /api/admin/checkout/viva {
                limit_except GET POST {
                    deny all;
                }
                limit_req zone=user_zone burst=250 nodelay;
                proxy_pass http://stack-motowear_nextjs:3000;
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            }

            location = /api/admin/aftersales {
                limit_except GET POST {
                    deny all;
                }
                limit_req zone=user_zone burst=250 nodelay;
                proxy_pass http://stack-motowear_nextjs:3000;
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            }

            location /api {
                limit_except POST DELETE OPTIONS {
                    deny all;
                }
                limit_req zone=user_zone burst=250 nodelay;
                proxy_pass http://stack-motowear_nextjs:3000;
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            }

            location ~* ^/_next/image {
                limit_except GET {
                    deny all;
                }
                limit_req zone=user_zone burst=250 nodelay;
                proxy_pass http://stack-motowear_nextjs:3000;
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                expires 1y;
                add_header Cache-Control "public, max-age=31536000, immutable";
            }

            location ~* ^/_next/static/ {
                limit_except GET {
                    deny all;
                }
                limit_req zone=user_zone burst=250 nodelay;
                proxy_pass http://stack-motowear_nextjs:3000;
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                expires 1y;
                add_header Cache-Control "public, max-age=31536000, immutable";
            }

            location ~* \.(ico|png|svg|woff2|woff|ttf|otf)$ {
                limit_except GET {
                    deny all;
                }
                limit_req zone=user_zone burst=250 nodelay;
                proxy_pass http://stack-motowear_nextjs:3000;
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                expires 1y;
                add_header Cache-Control "public, max-age=31536000, immutable";
            }

            location / {
                limit_except GET {
                    deny all;
                }
                limit_req zone=user_zone burst=250 nodelay;
                proxy_pass http://stack-motowear_nextjs:3000;
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            }

            error_log /var/log/nginx/error.log notice;
            access_log /var/log/nginx/access.log;
        }
    }
